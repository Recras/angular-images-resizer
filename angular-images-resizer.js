"use strict";angular.module("images-resizer",[]),angular.module("images-resizer").service("resizeService",["$q","$document","$window",function(e,t,r){var i,a=this,o=!(!t[0].createElement("canvas").getContext||!t[0].createElement("canvas").getContext("2d"));this.createImage=function(t,i){var a=e.defer(),o=new r.Image;return i&&(o.crossOrigin=i),o.onload=function(){a.resolve(o)},o.onabort=function(){a.reject("image creation was aborted")},o.onerror=function(e){a.reject(e)},o.src=t,a.promise},this.resizeCanvas=function(e,r,i){if(!r||!i)return e;var a=t[0].createElement("canvas");a.width=r,a.height=i;var o=a.getContext("2d");return o.drawImage(e,0,0,a.width,a.height),a},this.resizeImage=function(t,r){if(!o)return e.reject("Canvas is not supported on your browser");if(!r||!t)return e.reject("Missing argument when calling resizeImage function");var i=e.defer();return r={height:r.height?r.height:r.width?null:r.size?null:1024,width:r.width?r.width:r.height?null:r.size?null:1024,size:r.size?r.size:500,sizeScale:r.sizeScale?r.sizeScale:"kb",step:r.step?r.step:3,outputFormat:r.outputFormat?r.outputFormat:"image/jpeg",outputAs:r.outputAs?r.outputAs:"dataUrl",crossOrigin:r.crossOrigin?r.crossOrigin:null},a.createImage(t,r.crossOrigin).then(function(e){if(r.height||r.width)i.resolve(a.resizeImageWidthHeight(e,r.width,r.height,r.step,r.outputFormat,r.outputAs));else if(r.size){if(angular.isString(r.sizeScale))switch(r.sizeScale.toLowerCase()){case"kb":r.size*=1024;break;case"mb":r.size*=1048576;break;case"gb":r.size*=1073741824}i.resolve(a.resizeImageBySize(e,r.size,r.outputFormat,r.outputAs))}else i.reject("Missing option to resize the image")})["catch"](i.reject),i.promise},this.resizeImageWidthHeight=function(e,r,a,o,s,n){if(!e)return null;s||(s="image/jpeg"),n=n&&"blob"===n.toLowerCase()?"blob":"dataurl",i=t[0].createElement("canvas"),r||a?!r&&a?r=a/e.height*e.width:r&&!a&&(a=r/e.width*e.height):(r=e.width,a=e.height);var h=e.width!==r&&o?(e.width-r)/o:0,l=e.height!==a&&o?(e.height-a)/o:0;i.width=e.width,i.height=e.height,i.getContext("2d").drawImage(e,0,0,i.width,i.height);for(var c=1;c<o;c++){var g=e.width-h*c,u=e.height-l*c;i=this.resizeCanvas(i,g,u)}return i=this.resizeCanvas(i,r,a),"blob"===n?i.toBlob(s):i.toDataURL(s)},this.resizeImageBySize=function(e,r,o,s){if(!e)return null;o||(o="image/jpeg"),s=s&&"blob"===s.toLowerCase()?"blob":"dataurl",i=t[0].createElement("canvas"),i.width=e.width,i.height=e.height,i.getContext("2d").drawImage(e,0,0,i.width,i.height);var n;n="blob"===s?i.toBlob(o):i.toDataURL(o);for(var h=n,l=a.calulateImageSize(n,o),c=Math.max(1,Math.min(l/r,200)),g=20;l>r&&0!==g;){g--;var u={width:i.width/c,height:i.height/c},E=this.resizeCanvas(i,u.width,u.height);n="blob"===s?E.toBlob(o):E.toDataURL(o);var d=a.calulateImageSize(n,o);d/r<.5||0===d?(c/=2,c<1&&(g=0)):(i=E,h=n,l=d),i=E}return h},this.calulateImageSize=function(e,t){switch(t){case"image/jpg":t="image/jpeg";break;case"image/png":t="image/png";break;default:t="image/jpeg"}return Math.max(0,Math.round(3*(e.length-("data:"+t+";base64,").length)/4))}}]),angular.module("images-resizer").service("readLocalPicService",["$q","$window",function(e,t){function r(e){var t=null;switch(e.target.error.code){case FileError.NOT_FOUND_ERR:t="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:t="SECURITY_ERR";break;case FileError.ABORT_ERR:t="ABORT_ERR";break;case FileError.NOT_READABLE_ERR:t="NOT_READABLE_ERR";break;case FileError.ENCODING_ERR:t="ENCODING_ERR";break;case FileError.NO_MODIFICATION_ALLOWED_ERR:t="NO_MODIFICATION_ALLOWED_ERR";break;case FileError.INVALID_STATE_ERR:t="INVALID_STATE_ERR";break;case FileError.SYNTAX_ERR:t="SYNTAX_ERR";break;case FileError.INVALID_MODIFICATION_ERR:t="INVALID_MODIFICATION_ERR";break;case FileError.QUOTA_EXCEEDED_ERR:t="QUOTA_EXCEEDED_ERR";break;case FileError.TYPE_MISMATCH_ERR:t="TYPE_MISMATCH_ERR";break;case FileError.PATH_EXISTS_ERR:t="PATH_EXISTS_ERR";break;default:t="Unknown Error: "+e.target.error.code}return t}this.readFileInput=function(i){var a=e.defer();if(i.files&&i.files[0]){t.File&&t.FileReader&&t.FileList&&t.Blob||a.reject("Your browser do not support reading file");var o=new t.FileReader;o.onload=function(e){a.resolve(e.target.result)},o.onabort=function(e){a.reject("Fail to convert file in base64img, aborded: "+r(e))},o.onerror=function(e){a.reject("Fail to convert file in base64img, error: "+r(e))},o.readAsDataURL(i.files[0])}else a.reject("No file selected");return a.promise}}]);